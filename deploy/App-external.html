<!DOCTYPE html>
<html>
<head>
    <title>EVC</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",iterations:[],iterationPageCounter:1,filters:[],pagesize:200,items:[{xtype:"container",itemId:"stats",margin:10},{xtype:"container",itemId:"chart"}],launch:function(){this._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Calculating...Please wait."}),this._myMask.show(),this.makeInitialFilter()},makeInitialFilter:function(){var filters=[],now=new Date,today=now.toISOString().slice(0,10),context=this.getContext(),currentProjectRef=context.getProject()._ref,dateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"EndDate",operator:"<",value:today});this.filters.push(dateFilter),this.applyInitialFilterToIterations()},applyInitialFilterToIterations:function(){var store=this.makeIterationStore(),iterations=[];store.addFilter(this.filters),store.loadPage(this.iterationPageCounter,{scope:this,callback:function(records,operation){operation.wasSuccessful()&&records.length>0&&(_.each(records,function(record){this.iterations.push(record.get("Name"))},this),this.getMaxNumberOfUniqueIterationNames())}})},makeIterationStore:function(){var dataScope=this.getContext().getDataContext(),store=Ext.create("Rally.data.wsapi.Store",{model:"Iteration",fetch:["ObjectID","Name","StartDate","EndDate","PlanEstimate"],context:dataScope,pageSize:10,limit:10,sorters:[{property:"EndDate",direction:"DESC"}]},this);return store},getMaxNumberOfUniqueIterationNames:function(){var max=10;this.iterationPageCounter++,this.iterations=_.uniq(this.iterations),this.iterations.length>10&&(this.iterations=this.iterations.slice(0,10)),max>this.iterations.length?this.applyInitialFilterToIterations():(this.iterations.reverse(),this.makeFiltersForArtifacts())},makeFiltersForArtifacts:function(){var iterationFilters=[];_.each(this.iterations,function(iteration){var filter=Ext.create("Rally.data.wsapi.Filter",{property:"Iteration.Name",value:iteration});iterationFilters.push(filter)}),this.makeArtifactStore(iterationFilters)},makeArtifactStore:function(iterationFilters){var numOfIterations=iterationFilters.length;this.artifacts=Array(numOfIterations);for(var i=0;numOfIterations>i;i++)this.artifacts[i]=[];this.iterationFilters=iterationFilters,this.artifactStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["Defect","DefectSuite","UserStory"],fetch:["ObjectID","Name","FormattedID","ScheduleState","PlanEstimate","AcceptedDate","Iteration","Project","StartDate","EndDate"],limit:1/0}),this.applyIterationFiltersToArtifactStore(0)},applyIterationFiltersToArtifactStore:function(i){this.artifactStore.addFilter(this.iterationFilters[i]),this.artifactStore.load({scope:this,callback:function(records,operation){operation.wasSuccessful()&&(_.each(records,function(record){this.artifacts[i].push({_ref:record.get("_ref"),FormattedID:record.get("FormattedID"),Name:record.get("Name"),PlanEstimate:record.get("PlanEstimate"),ScheduleState:record.get("ScheduleState"),AcceptedDate:record.get("AcceptedDate")&&Rally.util.DateTime.toIsoString(record.get("AcceptedDate"))||null,ProjectName:record.get("Project")._refObjectName,IterationName:record.get("Iteration")._refObjectName,IterationRef:record.get("Iteration")._ref,IterationStartDate:record.get("Iteration").StartDate,IterationEndDate:record.get("Iteration").EndDate,IterationPlanEstimate:record.get("Iteration").PlanEstimate})},this),this.artifactStore.clearFilter(records.length),this.iterationFilters.length-1>i?this.applyIterationFiltersToArtifactStore(i+1):this.prepareChart())}})},prepareChart:function(){var series=[],categories=[],acceptedDuringIteration=[],acceptedAfterIteration=[],notAccepted=[];this.artifacts=_.filter(this.artifacts,function(artifactsPerIterationName){return 0!==artifactsPerIterationName.length}),_.each(this.artifacts,function(artifactsPerIterationName){var pointsAcceptedDuringIteration=0,pointsAcceptedAfterIteration=0,pointsNotAccepted=0,data=[],name=artifactsPerIterationName[0].IterationName;categories.push(name),_.each(artifactsPerIterationName,function(artifact){null===artifact.AcceptedDate?pointsNotAccepted+=artifact.PlanEstimate:artifact.AcceptedDate>=artifact.IterationStartDate&&artifact.AcceptedDate<=artifact.IterationEndDate?pointsAcceptedDuringIteration+=artifact.PlanEstimate:pointsAcceptedAfterIteration+=artifact.PlanEstimate}),acceptedDuringIteration.push(pointsAcceptedDuringIteration),acceptedAfterIteration.push(pointsAcceptedAfterIteration),notAccepted.push(pointsNotAccepted)},this),series.push({name:"Not Accepted",data:notAccepted}),series.push({name:"Accepted After Iteration",data:acceptedAfterIteration}),series.push({name:"Accepted During Iteration",data:acceptedDuringIteration}),this.makeChart(series,categories)},makeChart:function(series,categories){for(var few=3,numOfIterations=series[2].data.length,combinedAccepted=[],lastFewAccepted=[],bestFewAccepted=[],worstFewAccepted=[],avgLast=0,avgBest=0,avgWorst=0,totalLast=0,totalBest=0,totalWorst=0,i=0;numOfIterations>i;i++){var sum=series[1].data[i]+series[2].data[i];combinedAccepted.push(sum)}lastFewAccepted=_.last(combinedAccepted,few),bestFewAccepted=_.last(combinedAccepted.sort(function(a,b){return a-b}),few),worstFewAccepted=_.last(combinedAccepted.sort(function(a,b){return b-a}),few),_.each(lastFewAccepted,function(element){totalLast+=element}),_.each(bestFewAccepted,function(element){totalBest+=element}),_.each(worstFewAccepted,function(element){totalWorst+=element}),avgLast=parseFloat(parseFloat(totalLast/few).toFixed(2)),avgBest=parseFloat(parseFloat(totalBest/few).toFixed(2)),avgWorst=parseFloat(parseFloat(totalWorst/few).toFixed(2)),Ext.ComponentQuery.query("container[itemId=stats]")[0].update("Average accepted for last 3 iterations: "+avgLast+"</br>"+"Average accepted for best 3 iterations: "+avgBest+"</br>"+"Average accepted for worst 3 iterations: "+avgWorst+"</br>"),this._myMask.hide(),this.down("#chart").add({xtype:"rallychart",chartConfig:{chart:{type:"column",zoomType:"xy"},title:{text:"Velocity Chart"},xAxis:{title:{text:"Iterations"}},yAxis:{title:{text:"Plan Estimates"},allowDecimals:!1,min:0},plotOptions:{column:{stacking:"normal"}}},chartData:{series:series,categories:categories}})}});

            Rally.launchApp('CustomApp', {
                name:"EVC",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
